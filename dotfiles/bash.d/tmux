#!/usr/bin/env bash

DEFAULT_SESSION="work"
SH_CMD="exec bash"
WORKDIR_CMD="cd ${WORK_DIR}; ${SH_CMD}"

function trimSession() {
  local name=$1;
  echo ${1};
}

# This should only ever return either "0" or "1"
function tmuxSessionMatches() {
  local name=$1
  echo $(tmux ls | grep "^${name}$" | wc -l)
}

function configureWindows() {
  tmux set-window-option -t ${DEFAULT_SESSION} -g automatic-rename off;
  tmux new-window        -t ${DEFAULT_SESSION}:0 -k -n devops "${WORKDIR_CMD}";
  tmux split-window -h   -t ${DEFAULT_SESSION}:0 "${WORKDIR_CMD}";
  tmux split-window -v   -t ${DEFAULT_SESSION}:0 "${WORKDIR_CMD}";
}

tmux start-server
if [ -z $TMUX ]; then
  if [ ! -z "$SSHAGENT" ]; then
    echo "Starting ssh-agent ${SSH_AUTH_SOCK}..."
    CMD="$SSHAGENT $SSHAGENTARGS"
    echo "Evaluating $CMD"
    SSHAGENTOUT=$($CMD)
    echo "Output $SSHAGENTOUT"
    eval $SSHAGENTOUT
  fi

  if [ $(tmuxSessionMatches ${DEFAULT_SESSION}) -eq 0 ]; then
    echo "Launching tmux base session ${DEFAULT_SESSION}..."
    tmux new-session -d -s ${DEFAULT_SESSION}
    configureWindows
    tmux attach -t ${DEFAULT_SESSION}
  else
    echo "Launching synced copy of base session ${DEFAULT_SESSION}..."
    sid="${DEFAULT_SESSION}-$(date +%Y%m%d%H%M%S)"
    tmux new-session -d -t ${sid} -s ${DEFAULT_SESSION}
    configureWindows
    tmux attach -t ${sid}
  fi
fi
